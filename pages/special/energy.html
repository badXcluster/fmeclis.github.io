<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Energy Dashboard - Fatih Meclis</title>
  <link rel="stylesheet" href="../../style.css">
  <style>
    :root { --turkuaz: #008080; --turkuaz-dark: #024a4a; --accent: #8fb6ec; }
    body { font-family: "Segoe UI", Arial, sans-serif; margin:0; background:#f7f7f7; color:#111; }
    .energy-wrap { padding:80px; background:#f7f7f7; min-height:100vh; }
    .sheet { background:white; padding:15px; border-radius:6px; box-shadow:0 1px 6px rgba(0,0,0,0.06); max-width:1200px; margin:auto; }
    h1 { margin:0 0 10px 0; font-size:20px; }
    table { border-collapse:collapse; width:100%; margin-bottom:8px; }
    th,td { border:1px solid #cfcfcf; padding:6px 8px; font-size:13px; text-align:center; }
    th { background:#e6f0ff; }
    .section-title { background:var(--turkuaz-dark); color:#fff; font-weight:700; font-size:15px; padding:10px; margin:16px 0 8px 0; border-radius:6px; display:flex; justify-content:space-between; align-items:center; border:1px solid var(--accent); }
    .pill { font-size:12px; color:#fff; font-weight:400; }
    header.site-header { background: var(--turkuaz); color:#fff; padding:12px 18px; border-bottom:1px solid rgba(255,255,255,0.1); }
    footer { text-align:center; padding:18px 0; border-top:1px solid #eee; margin-top:20px; }
  </style>
</head>
<body>

<header class="site-header">
  <div style="max-width:1200px;margin:auto;display:flex;justify-content:space-between;align-items:center;">
    <div style="display:flex;align-items:center;gap:10px;">
      <img src="../../images/siteimages/FMLOGO.bmp" style="height:40px">
      <div>
        <h2 style="margin:0;font-size:18px;">Fatih Meclis</h2>
        <div style="font-size:13px;opacity:0.8;">Personal Website & Engineering Portfolio</div>
      </div>
    </div>
    <nav>
      <a href="../../index.html" style="color:#fff;">HOME</a>
    </nav>
  </div>
</header>

<div class="energy-wrap" id="energySection">
  <div class="sheet">
    <h1>HOME — Energy Consumption Dashboard</h1>
    <div class="muted" style="margin-bottom:6px;">Auto-updates every 30s.</div>

    <div class="section-title">BAŞKENTGAZ <span class="pill">Last update: <span id="gasUpdate"></span></span></div>
    <table id="gasTable"><tbody><tr><td>Loading...</td></tr></tbody></table>

    <div class="section-title">ENERJİSA <span class="pill">Last update: <span id="elecUpdate"></span></span></div>
    <table id="elecTable"><tbody><tr><td>Loading...</td></tr></tbody></table>

    <div class="section-title">ASKİ <span class="pill">Last update: <span id="waterUpdate"></span></span></div>
    <table id="waterTable"><tbody><tr><td>Loading...</td></tr></tbody></table>
  </div>
</div>

<footer>&copy; 2025 Fatih Meclis. All rights reserved.</footer>

<script>
const tariffFile = "../../data/askiTariff.json";

const gasConfig = {
  prefix: "gas",
  firstDateStr: "2025-10-06T11:19:57",
  firstReading: 6982,
  lastReading: 7074.90,
  unitPrice: 11.50
};
const elecConfig = {
  prefix: "elec",
  firstDateStr: "2025-10-01T09:00:00",
  firstReading: 1798.723,
  lastReading: 1943.04,
  unitPrice: 2.60
};
const waterConfig = {
  prefix: "water",
  firstDateStr: "2025-10-07T00:00:00",
  firstReading: 951,
  lastReading: 964
};

function fmt(v,dp=2){return (isNaN(v)||v===null)?"--":Number(v).toLocaleString(undefined,{minimumFractionDigits:dp,maximumFractionDigits:dp});}
function daysBetween(d1,d2){return (d2-d1)/(1000*60*60*24);}

async function loadTariff(){
  try{
    const r = await fetch(tariffFile);
    if(!r.ok) throw new Error("HTTP "+r.status);
    return await r.json();
  }catch(e){console.error(e);return null;}
}

async function updateConsumption(cfg){
  const now = new Date();
  const firstDate = new Date(cfg.firstDateStr);
  const days = daysBetween(firstDate,now);
  const cons = cfg.lastReading - cfg.firstReading;
  const daily = cons/days;
  const est = daily*30;
  const cost = cons*cfg.unitPrice;
  const estCost = est*cfg.unitPrice;

  const table = document.getElementById(cfg.prefix+"Table");
  table.innerHTML = `
    <thead><tr><th>Period</th><th>First Date</th><th>First Reading</th><th>Now</th><th>Last Reading</th><th>Days</th><th>Cons</th><th>Daily Avg</th><th>Est. 30d</th><th>Unit TL</th><th>Cost</th><th>Est. Cost</th></tr></thead>
    <tbody><tr>
      <td>Ekim25</td>
      <td>${firstDate.toLocaleString()}</td>
      <td>${fmt(cfg.firstReading)}</td>
      <td>${now.toLocaleString()}</td>
      <td>${fmt(cfg.lastReading)}</td>
      <td>${fmt(days,2)}</td>
      <td>${fmt(cons,2)}</td>
      <td>${fmt(daily,3)}</td>
      <td>${fmt(est,2)}</td>
      <td>${fmt(cfg.unitPrice)}</td>
      <td>${fmt(cost)}</td>
      <td>${fmt(estCost)}</td>
    </tr></tbody>`;
  document.getElementById(cfg.prefix+"Update").textContent = now.toLocaleTimeString();
}

async function updateWater() {
  const tariff = await loadTariff();
  const now = new Date();
  document.getElementById("waterUpdate").textContent = now.toLocaleTimeString();
  const table = document.getElementById("waterTable");

  const firstDate = new Date(waterConfig.firstDateStr);
  const days = daysBetween(firstDate, now);
  const cons = waterConfig.lastReading - waterConfig.firstReading;
  const daily = cons / days;
  const est = daily * 30;

  // --- Kademe sınırları
  const kademeLimits = [10, 15, 30]; // upper bounds for first three tiers

  // --- 30 günlük tahmini tüketimi kademelere dağıt
  let kademeler = [0, 0, 0, 0];
  let remaining = est;
  if (remaining > 0) {
    kademeler[0] = Math.min(remaining, kademeLimits[0]); remaining -= kademeler[0];
    kademeler[1] = Math.min(Math.max(0, remaining), kademeLimits[1]-kademeLimits[0]); remaining -= kademeler[1];
    kademeler[2] = Math.min(Math.max(0, remaining), kademeLimits[2]-kademeLimits[1]); remaining -= kademeler[2];
    kademeler[3] = Math.max(0, remaining);
  }

  let totalInd = 0, totalNor = 0;
  if (tariff) {
    for (let i = 0; i < 4; i++) {
      const ind = tariff.indirimli[i];
      const nor = tariff.normal[i];
      const vol = kademeler[i];
      totalInd += vol * (ind.su + ind.atik);
      totalNor += vol * (nor.su + nor.atik);
    }
    // CTV ve KDV ekle
    totalInd += tariff.ctv;
    totalNor += tariff.ctv;
    totalInd *= (1 + tariff.kdv.su + tariff.kdv.atik);
    totalNor *= (1 + tariff.kdv.su + tariff.kdv.atik);
  }

  // --- 1️⃣ Üst tablo: kullanım ve tahmini tutarlar
  let consumptionHTML = `
    <thead>
      <tr>
        <th>Period</th>
        <th>First Date</th>
        <th>First Reading</th>
        <th>Now</th>
        <th>Last Reading</th>
        <th>Days</th>
        <th>Usage (m³)</th>
        <th>Daily Avg (m³)</th>
        <th>Est. 30d (m³)</th>
        <th>Est. Discounted (TL)</th>
        <th>Est. Normal (TL)</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Ekim25</td>
        <td>${firstDate.toLocaleString()}</td>
        <td>${fmt(waterConfig.firstReading)}</td>
        <td>${now.toLocaleString()}</td>
        <td>${fmt(waterConfig.lastReading)}</td>
        <td>${fmt(days, 2)}</td>
        <td>${fmt(cons, 2)}</td>
        <td>${fmt(daily, 3)}</td>
        <td>${fmt(est, 2)}</td>
        <td>${fmt(totalInd, 2)}</td>
        <td>${fmt(totalNor, 2)}</td>
      </tr>
    </tbody>
  `;

  // --- 2️⃣ Tarife tablosu (alt kısım)
  if (!tariff) {
    table.innerHTML = consumptionHTML + "<tr><td>Tarife yüklenemedi.</td></tr>";
    return;
  }

  const len = Math.max(tariff.indirimli.length, tariff.normal.length);
  let tariffRows = "";
  for (let i = 0; i < len; i++) {
    const indSu = tariff.indirimli[i]?.su ?? "-";
    const indAtik = tariff.indirimli[i]?.atik ?? "-";
    const norSu = tariff.normal[i]?.su ?? "-";
    const norAtik = tariff.normal[i]?.atik ?? "-";
    tariffRows += `
      <tr>
        <td>${i + 1}</td>
        <td>${indSu}</td>
        <td>${indAtik}</td>
        <td>${norSu}</td>
        <td>${norAtik}</td>
      </tr>
    `;
  }

  const tariffHTML = `
    <thead>
      <tr>
        <th>Kademe</th>
        <th>İndirimli Su (TL/m³)</th>
        <th>İndirimli Atık (TL/m³)</th>
        <th>Normal Su (TL/m³)</th>
        <th>Normal Atık (TL/m³)</th>
      </tr>
    </thead>
    <tbody>${tariffRows}</tbody>
    <tfoot>
      <tr>
        <td colspan="5" style="text-align:left;font-size:12px;color:#555;">
          CTV: ${tariff.ctv} TL • KDV (su): ${(tariff.kdv.su * 100).toFixed(0)}% • KDV (atık): ${(tariff.kdv.atik * 100).toFixed(0)}%
        </td>
      </tr>
    </tfoot>
  `;

  table.innerHTML = consumptionHTML + "<tr><td colspan='11' style='padding:4px;'></td></tr>" + tariffHTML;
}



async function runAll(){
  await updateConsumption(gasConfig);
  await updateConsumption(elecConfig);
  await updateWater();
}

runAll();
setInterval(runAll, 30000);
</script>

</body>
</html>
