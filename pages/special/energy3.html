<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Energy Dashboard - Fatih Meclis</title>
  <link rel="stylesheet" href="style.css" />
  <style>
  
    /* Scoped styles for dashboard */
  :root { --turkuaz-dark: #024a4a; --turkuaz-darker: #013536; --accent: #8fb6ec; }
  body { font-family: "Segoe UI", Arial, sans-serif; margin:0; background:#fff; color:#111; }
  .energy-wrap { padding: 80px; background:#f7f7f7; min-height:100vh; }
  .sheet { background: white; padding:15px; border-radius:6px; box-shadow: 0 1px 6px rgba(0,0,0,0.06); max-width:1200px; margin:auto; }
  h1 { margin:0 0 10px 0; font-size:20px; }
  table { border-collapse: collapse; width:100%; margin-bottom:8px; }
  th, td { border:1px solid #cfcfcf; padding:6px 8px; font-size:13px; vertical-align:middle; }
  th { background:#e6f0ff; text-align:center; font-weight:600; }
  td.num { text-align:center; font-family: "Segoe UI", Arial, sans-serif; }
  .section-title { background: var(--turkuaz-dark); color: #fff; font-weight:700; font-size:15px; padding:10px; margin:16px 0 8px 0; border-radius:6px; display:flex; justify-content:space-between; align-items:center; border:1px solid var(--accent); }
  .section-title .pill { font-weight:400; font-size:13px; color:#fff; }
  .section-title.monthlyAnalysis { background: #d2e7ec; color:#111; font-weight:600; border:1px solid var(--accent); display:block; }
  .progress-container { position: relative; width: 60%; margin: 6px 0; background-color: #ddd; border-radius:10px; height:12px; }
  .progress-bar { height:100%; border-radius:10px; transition: width 0.8s ease, background-color 0.8s ease; }
  .progress-limit-line { position:absolute; left:100%; top:0; bottom:0; width:4px; background:#444; transform:translateX(-2px); }
  .small { font-size:13px; color:#333; }
  .muted { color:#666; font-size:13px; }
  .grid { display:flex; gap:18px; align-items:flex-start; }
  .left { flex:1; }
  .right { width:360px; }
  .card { background:#fafafa; padding:10px; border-radius:6px; border:1px solid #eee; }
  .tariff-table th, .tariff-table td { padding:6px 8px; font-size:13px; text-align:center; }
  .calc-line { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #eee; }
  .calc-line:last-child { border-bottom:none; font-weight:700; }
  .ok { color:green; font-weight:600; }
  .warn { color:orange; font-weight:700; }
  .danger { color:#b30000; font-weight:700; }
  /* center date cells by attribute */
  td[id$="DateCell"] { text-align:center; }
  /* responsive */
  @media (max-width:980px) { .grid { flex-direction:column; } .right{ width:100%; } .progress-container{ width:100%; } }
  /* Password screen overlay */
  #accessScreen { display:flex; flex-direction:column; align-items:center; justify-content:center; height:70vh; text-align:center; padding:18px; }
  #accessScreen input { padding:10px 12px; width:240px; font-size:15px; border-radius:6px; border:1px solid #aaa; margin-top:8px; }
  #accessScreen button { margin-top:10px; padding:8px 16px; border-radius:6px; border:none; background:var(--turkuaz-dark); color:#fff; cursor:pointer; }
  #wrongPass { color:red; display:none; margin-top:8px; }
  /* keep header simple */
  header.site-header { background:#fff; border-bottom:1px solid #eee; padding:10px 18px; }
  header .logo-title { display:flex; gap:10px; align-items:center; }
  header img{height:40px;}
    
  /* SayfanÄ±n geri kalanÄ± kendi renginde kalacak, ama header orijinal stil dosyasÄ±ndan beslenecek */
  header.site-header {
    background: transparent !important;
  }

  /* EÄŸer sayfanÄ±n body kÄ±smÄ±na Ã¶zel bir arka plan atadÄ±ysak, sadece ana iÃ§erik iÃ§in uygula */
  main.page-content {
    background-color: #f8f9fa; /* veya eski energy dashboard'un arka planÄ± */
  }  
    
  </style>
</head>
<body>

  <!-- SITE HEADER -->
  <header class="site-header" id="mainHeader">
    <div class="header-content" style="max-width:1200px;margin:auto;display:flex;justify-content:space-between;align-items:center;">
      <div class="logo-title">
        <img src="images/siteimages/FMLOGO.bmp" alt="Fatih Meclis Logo"/>
        <div>
          <h2 style="margin:0;font-size:18px;">Fatih Meclis</h2>
          <div class="muted">Personal Website & Engineering Portfolio</div>
        </div>
      </div>
      <nav class="navbar">
        <ul style="list-style:none;display:flex;gap:14px;margin:0;padding:0;">
          <li><a href="index.html">HOME</a></li>
          <li><a href="pages/photos/photos.htm">PHOTOS</a></li>
          <li><a href="pages/myworks/myworks.htm">MY WORKS</a></li>
          <li><a href="pages/contact/contact.htm">CONTACT</a></li>
          <li><a href="pages/blog/blog.htm">BLOG</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- ACCESS SCREEN (shows until correct password) -->
  <div id="accessScreen">
    <h2>ðŸ”’ Restricted Access</h2>
    <p>Please enter the access code to view Private Area:</p>
    <input type="password" id="accessCode" placeholder="Enter code..." />
    <button id="accessBtn">Enter</button>
    <div id="wrongPass">Incorrect code. Please try again.</div>
  </div>

  <!-- DASHBOARD (hidden until access granted) -->
  <div class="energy-wrap" style="display:none;" id="protectedArea">
    <div class="sheet">

      <h1>HOME â€” Energy Consumption Dashboard</h1>
      <div class="muted" style="margin-bottom:6px;">Auto-updates on page load. Edit values in the script block to change readings.</div>

      <!-- GAS -->
      <div class="section-title">BAÅžKENTGAZ <div class="pill">Auto-updates: <span id="nowText"></span></div></div>
      <table id="gasTable">
        <thead>
          <tr>
            <th>Period</th>
            <th>First Reading Date</th>
            <th>First Reading</th>
            <th>Last Reading Date</th>
            <th>Last Reading</th>
            <th>Days Passed</th>
            <th>Consumption (mÂ³)</th>
            <th>Daily AVG (mÂ³/d)</th>
            <th>Est. Monthly (mÂ³)</th>
            <th>Unit Price (TL/mÂ³)</th>
            <th>Actual Cost (TL)</th>
            <th>Est. Cost (TL)</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="small">Ekim25</td>
            <td id="gas_firstDateCell">--</td>
            <td id="gas_firstReadingCell" class="num">--</td>
            <td id="gas_nowDateCell">--</td>
            <td id="gas_lastReadingCell" class="num">--</td>
            <td id="gas_daysCell" class="num">--</td>
            <td id="gas_consCell" class="num">--</td>
            <td id="gas_dailyAvgCell" class="num">--</td>
            <td id="gas_estMonthlyCell" class="num">--</td>
            <td id="gas_unitPriceCell" class="num">--</td>
            <td id="gas_periodTotalCostCell" class="num">--</td>
            <td id="gas_estMonthlyCostCell" class="num">--</td>
          </tr>
          <tr>
            <td colspan="12">
              <div class="progress-container">
                <div id="gas_progressBar" class="progress-bar"></div>
                <div class="progress-limit-line"></div>
              </div>
              <div id="gas_limitNote" class="small"></div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Monthly analysis (gas) -->
      <div class="section-title monthlyAnalysis">MONTHLY GAS ANALYSIS for past 5 years</div>
      <table id="monthlyAnalysis">
        <tbody>
          <tr style="background-color:#eaf3ff;">
            <th>Month</th><td>Ocak</td><td>Åžubat</td><td>Mart</td><td>Nisan</td><td>MayÄ±s</td><td>Haziran</td><td>Temmuz</td><td>AÄŸustos</td><td>EylÃ¼l</td><td>Ekim</td><td>KasÄ±m</td><td>AralÄ±k</td>
          </tr>
          <tr><th>Daily AVG (mÂ³/d)</th><td>3.23</td><td>3.91</td><td>2.97</td><td>1.92</td><td>0.89</td><td>0.77</td><td>0.66</td><td>0.56</td><td>0.72</td><td>1.37</td><td>2.75</td><td>3.35</td></tr>
          <tr><th>Monthly AVG (mÂ³/mo)</th><td>100.21</td><td>113.46</td><td>91.99</td><td>57.47</td><td>27.74</td><td>23.07</td><td>20.61</td><td>17.50</td><td>21.52</td><td>42.61</td><td>82.62</td><td>103.78</td></tr>
        </tbody>
      </table>

      <!-- ELECTRICITY -->
      <div class="section-title electricity">ENERJÄ°SA</div>
      <table id="elecTable">
        <thead>
          <tr>
            <th>Period</th><th>First Date</th><th>First Reading</th><th>Last Date</th><th>Last Reading</th><th>Days</th><th>Usage</th><th>Daily AVG</th><th>Est. Monthly</th><th>Unit Price</th><th>Actual Cost</th><th>Est. Cost</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="small">Ekim25</td>
            <td id="elec_firstDateCell">--</td>
            <td id="elec_firstReadingCell" class="num">--</td>
            <td id="elec_nowDateCell">--</td>
            <td id="elec_lastReadingCell" class="num">--</td>
            <td id="elec_daysCell" class="num">--</td>
            <td id="elec_consCell" class="num">--</td>
            <td id="elec_dailyAvgCell" class="num">--</td>
            <td id="elec_estMonthlyCell" class="num">--</td>
            <td id="elec_unitPriceCell" class="num">--</td>
            <td id="elec_periodTotalCostCell" class="num">--</td>
            <td id="elec_estMonthlyCostCell" class="num">--</td>
          </tr>
          <tr>
            <td colspan="12">
              <div class="progress-container">
                <div id="elec_progressBar" class="progress-bar"></div>
                <div class="progress-limit-line"></div>
              </div>
              <div id="elec_limitNote" class="small"></div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- WATER -->
      <div class="section-title water">ASKÄ°</div>

      <!-- Left: calculations, Right: tariff table -->
      <div class="grid">
        <div class="left">
          <table id="waterTable">
            <thead>
              <tr>
                <th>Period</th><th>First Date</th><th>First Reading</th><th>Last Date</th><th>Last Reading</th><th>Days</th><th>Usage</th><th>Daily AVG</th><th>Est. Monthly</th><th>Unit Price</th><th>Actual Cost</th><th>Est. Cost</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="small">Ekim25</td>
                <td id="water_firstDateCell">--</td>
                <td id="water_firstReadingCell" class="num">--</td>
                <td id="water_nowDateCell">--</td>
                <td id="water_lastReadingCell" class="num">--</td>
                <td id="water_daysCell" class="num">--</td>
                <td id="water_consCell" class="num">--</td>
                <td id="water_dailyAvgCell" class="num">--</td>
                <td id="water_estMonthlyCell" class="num">--</td>
                <td id="water_unitPriceCell" class="num">--</td>
                <td id="water_periodTotalCostCell" class="num">--</td>
                <td id="water_estMonthlyCostCell" class="num">--</td>
              </tr>
              <tr>
                <td colspan="12">
                  <div class="progress-container">
                    <div id="water_progressBar" class="progress-bar"></div>
                    <div class="progress-limit-line"></div>
                  </div>
                  <div id="water_limitNote" class="small"></div>
                </td>
              </tr>
            </tbody>
          </table>

          <!-- Detailed breakdown card -->
          <div class="card" style="margin-top:8px;">
            <div style="display:flex;justify-content:space-between;font-weight:700;margin-bottom:6px;">DetaylÄ± Su HesabÄ±<span id="water_total_label" class="muted"></span></div>
            <div class="calc-line"><div>Su bedeli</div><div id="water_suCost">--</div></div>
            <div class="calc-line"><div>AtÄ±k su bedeli</div><div id="water_atikCost">--</div></div>
            <div class="calc-line"><div>KDV (su+atik)</div><div id="water_kdv">--</div></div>
            <div class="calc-line"><div>Ã‡TV</div><div id="water_ctv">--</div></div>
            <div class="calc-line"><div>Toplam</div><div id="water_total">--</div></div>
          </div>
        </div>

        <!-- Right: tariff table -->
        <div class="right">
          <div class="card">
            <div style="font-weight:700;margin-bottom:8px;">ASKÄ° Tarifesi (Normal)</div>
            <table class="tariff-table" id="tariffTable">
              <thead><tr><th>Kademe</th><th>Su (TL/mÂ³)</th><th>AtÄ±k (TL/mÂ³)</th></tr></thead>
              <tbody id="tariffBody"><tr><td colspan="3">YÃ¼kleniyor...</td></tr></tbody>
            </table>
            <div style="margin-top:8px;" class="muted">
              Ã‡TV: <span id="tariff_ctv">--</span> TL/mÂ³<br/>
              KDV Su: <span id="tariff_kdv_su">--</span>, KDV AtÄ±k: <span id="tariff_kdv_atik">--</span>
            </div>
          </div>
        </div>
      </div>

      <div class="footnote" style="margin-top:12px;">
        <strong>How to publish updates:</strong> Edit the values in the script section of this file (variables near top of the script) and commit/push to your GitHub Pages repo.
      </div>

    </div>
  </div>

  <footer style="text-align:center;padding:18px 0;border-top:1px solid #eee;margin-top:10px;">
    <p>&copy; 2025 Fatih Meclis. All rights reserved.</p>
  </footer>

  <!-- ===========================
       SCRIPTS â€” ordered and modular
       =========================== -->

  <!-- 1) CONFIGS / CONSTANTS -->
  <script>
  // Access code
  const ACCESS_CODE = "231"; // change as you like
  const tariffFile = "data/askiTariff.json"; // must exist in repo root /data/askiTariff.json

  // Editable readings (change these values when you update readings)
  const gasConfig = {
    prefix: "gas",
    firstDateStr: "2025-10-06T11:19:57",
    firstReading: 6982,
    lastReading: 7043.32,
    unitPrice: 11.50,
    limitType: "gas"
  };
  const elecConfig = {
    prefix: "elec",
    firstDateStr: "2025-10-01T09:00:00",
    firstReading: 1798.723,
    lastReading: 1902.55,
    unitPrice: 2.60,
    dailyLimit: 5.65,
    monthlyLimit: 169.5,
    limitType: "fixed"
  };
  const waterConfig = {
    prefix: "water",
    firstDateStr: "2025-10-07T11:19:57",
    firstReading: 951,
    lastReading: 961.5,
    unitPrice: 0, // not used for ASKÄ° normal calc; kept for fallback
    dailyLimit: 0.46,
    monthlyLimit: 13.8,
    limitType: "water"
  };
  </script>

  <!-- 2) HELPERS -->
  <script>
  const fmt = (v, dp=2) => (isNaN(v) || v===null) ? "--" : Number(v).toLocaleString(undefined, { minimumFractionDigits: dp, maximumFractionDigits: dp });
  const monthNamesTr = ["Ocak","Åžubat","Mart","Nisan","MayÄ±s","Haziran","Temmuz","AÄŸustos","EylÃ¼l","Ekim","KasÄ±m","AralÄ±k"];
  function daysBetween(d1, d2) { return (d2 - d1) / (1000*60*60*24); }
  </script>

  <!-- 3) ASKÄ° calc (matches Excel MYSU logic) -->
  <script>
  async function loadTariff() {
    try {
      const r = await fetch(tariffFile);
      if (!r.ok) throw new Error("Tariff HTTP " + r.status);
      const j = await r.json();
      return j;
    } catch (e) {
      console.error("Failed to load tariff:", e);
      return null;
    }
  }

  function calcAskiBreakdown(consumption, days, tariffData, mode="normal") {
    // tariffData: object parsed from JSON
    // mode: "normal" or "indirimli"
    if (!tariffData) return null;
    const t = tariffData;
    const BF = []; // su unit prices per band
    const ATIK = [];
    if (mode.toLowerCase() === "indirimli") {
      for (let i=0;i<4;i++){ BF[i]=t.indirimli[i].su; ATIK[i]=t.indirimli[i].atik; }
    } else {
      for (let i=0;i<4;i++){ BF[i]=t.normal[i].su; ATIK[i]=t.normal[i].atik; }
    }
    const CTV = Number(t.ctv ?? t.CTV ?? 0) || 0;
    const KDVsu = Number(t.kdv?.su ?? t.KDV?.su ?? 0) || 0;
    const KDVatik = Number(t.kdv?.atik ?? t.KDV?.atik ?? 0) || 0;

    // daily average (AVGD)
    const AVGD = consumption / days;
    const KADEME = [0,0,0,0];
    // Excel logic: thresholds in m3/day
    const lim1 = 0.3333, lim2 = 0.5, lim3 = 1.0;
    if (AVGD <= lim1) {
      KADEME[0] = AVGD * days;
    } else if (AVGD <= lim2) {
      KADEME[0] = lim1 * days;
      KADEME[1] = (AVGD - lim1) * days;
    } else if (AVGD <= lim3) {
      KADEME[0] = lim1 * days;
      KADEME[1] = (lim2 - lim1) * days;
      KADEME[2] = (AVGD - lim2) * days;
    } else {
      KADEME[0] = lim1 * days;
      KADEME[1] = (lim2 - lim1) * days;
      KADEME[2] = (lim3 - lim2) * days;
      KADEME[3] = (AVGD - lim3) * days;
    }

    // compute costs
    let suBedeli = 0, atikBedeli = 0;
    for (let i=0;i<4;i++) {
      suBedeli += KADEME[i] * (BF[i] || 0);
      atikBedeli += KADEME[i] * (ATIK[i] || 0);
    }
    const kdvTutar = (suBedeli * KDVsu) + (atikBedeli * KDVatik);
    const ctvTutar = AVGD * days * CTV;
    const total = suBedeli + atikBedeli + kdvTutar + ctvTutar;

    return {
      avgDaily: AVGD,
      perBand: KADEME,
      suBedeli, atikBedeli, kdvTutar, ctvTutar, total
    };
  }
  </script>

  <!-- 4) MAIN updateConsumption and orchestration -->
  <script>
  function readMonthlyAnalysis() {
    const rows = document.querySelectorAll('#monthlyAnalysis tbody tr');
    if (!rows.length) return {};
    const months = rows[0].querySelectorAll('td');
    const dailyAvgs = rows[1].querySelectorAll('td');
    const monthlyAvgs = rows[2].querySelectorAll('td');
    const data = {};
    for (let i=0;i<months.length;i++){
      const name = months[i].textContent.trim();
      data[name] = { daily: parseFloat(dailyAvgs[i]?.textContent)||0, monthly: parseFloat(monthlyAvgs[i]?.textContent)||0 };
    }
    return data;
  }

  async function updateConsumption(cfg, monthlyData={}) {
    const now = new Date();
    const firstDate = new Date(cfg.firstDateStr);
    let daysPassed = (now - firstDate) / (1000*60*60*24);
    if (daysPassed <= 0.00001) daysPassed = 0.00001;
    const cons = cfg.lastReading - cfg.firstReading;
    const dailyAvg = cons / daysPassed;
    const estMonthly = dailyAvg * 30;
    const cost = cons * cfg.unitPrice;
    const estCost = estMonthly * cfg.unitPrice;

    // write common fields
    document.getElementById(cfg.prefix + "_firstDateCell").textContent = firstDate.toLocaleString();
    document.getElementById(cfg.prefix + "_nowDateCell").textContent = now.toLocaleString();
    document.getElementById(cfg.prefix + "_firstReadingCell").textContent = fmt(cfg.firstReading,2);
    document.getElementById(cfg.prefix + "_lastReadingCell").textContent = fmt(cfg.lastReading,2);
    document.getElementById(cfg.prefix + "_daysCell").textContent = fmt(daysPassed,3);
    document.getElementById(cfg.prefix + "_consCell").textContent = fmt(cons,3);
    document.getElementById(cfg.prefix + "_dailyAvgCell").textContent = fmt(dailyAvg,4);
    document.getElementById(cfg.prefix + "_estMonthlyCell").textContent = fmt(estMonthly,3);
    document.getElementById(cfg.prefix + "_unitPriceCell").textContent = fmt(cfg.unitPrice,2);

    // progress/limit
    const noteEl = document.getElementById(cfg.prefix + "_limitNote");
    const barEl = document.getElementById(cfg.prefix + "_progressBar");
    let dailyLimit = 0, monthlyLimit = 0;
    if (cfg.limitType === "gas") {
      const currentMonth = monthNamesTr[now.getMonth()];
      const avg = monthlyData[currentMonth];
      if (avg) { dailyLimit = avg.daily*1.25; monthlyLimit = avg.monthly*1.25; }
    } else {
      dailyLimit = cfg.dailyLimit; monthlyLimit = cfg.monthlyLimit;
    }
    let percent = dailyLimit>0 ? (dailyAvg / dailyLimit) * 100 : 0;
    if (percent > 150) percent = 150;
    let color = percent>110 ? "red" : percent>90 ? "orange" : "green";
    if (barEl) { barEl.style.width = percent + "%"; barEl.style.backgroundColor = color; }

    // special handling for water (use tariff)
    if (cfg.limitType === "water") {
      noteEl.innerHTML = "<em>Calculating ASKÄ°...</em>";
      // load tariff, then calc
      const tariff = await loadTariff();
      if (!tariff) {
        noteEl.innerHTML = "<span style='color:red;'>Tariff load error</span>";
        document.getElementById(cfg.prefix + "_periodTotalCostCell").textContent = fmt(0,2);
        document.getElementById(cfg.prefix + "_estMonthlyCostCell").textContent = fmt(0,2);
        return;
      }
      // compute actual and estimated
      const breakdownActual = calcAskiBreakdown(cons, daysPassed, tariff, "normal");
      const breakdownEst = calcAskiBreakdown(estMonthly, 30, tariff, "normal"); // estMonthly is m3 per 30 days? keep consistent: we pass amount and days -> but calcAskiBreakdown expects consumption and days; Excel used AVGD and GUN; for est we treat estMonthly amount over 30 days
      // show details
      document.getElementById(cfg.prefix + "_periodTotalCostCell").textContent = fmt(breakdownActual.total,2);
      document.getElementById(cfg.prefix + "_estMonthlyCostCell").textContent = fmt(breakdownEst.total,2);
      document.getElementById("water_suCost").textContent = fmt(breakdownActual.suBedeli,2) + " TL";
      document.getElementById("water_atikCost").textContent = fmt(breakdownActual.atikBedeli,2) + " TL";
      document.getElementById("water_kdv").textContent = fmt(breakdownActual.kdvTutar,2) + " TL";
      document.getElementById("water_ctv").textContent = fmt(breakdownActual.ctvTutar,2) + " TL";
      document.getElementById("water_total").textContent = fmt(breakdownActual.total,2) + " TL";
      document.getElementById("water_total_label").textContent = `(${fmt(cons,2)} mÂ³)`;
      // set unit price cell to average unit price (total/cons) when cons>0
      document.getElementById(cfg.prefix + "_unitPriceCell").textContent = (cons>0 ? fmt(breakdownActual.total/cons,2) : "--");
      noteEl.innerHTML = `<span class="ok">âœ“ ASKÄ° hesaplandÄ± (Normal)</span> â€” GÃ¼nlÃ¼k ort: ${fmt(breakdownActual.avgDaily,3)} mÂ³/gÃ¼n`;
      // populate tariff table on right
      populateTariffTable(tariff, "normal");
      return;
    }

    // gas/electricity default behavior
    if (dailyAvg > dailyLimit) {
      const over = estMonthly - monthlyLimit;
      const extra = over * cfg.unitPrice;
      noteEl.innerHTML = `<span style="color:${color};font-weight:600;">âš  Above limit:</span> Daily ${fmt(dailyAvg)}/${fmt(dailyLimit)} â†’ Est. Monthly ${fmt(estMonthly)} vs limit ${fmt(monthlyLimit)}. <span class='muted'>Extra â‰ˆ ${fmt(extra)} TL</span>`;
    } else {
      noteEl.innerHTML = `<span style="color:${color};font-weight:600;">âœ“ Within limit</span> (Daily ${fmt(dailyAvg)}/${fmt(dailyLimit)}, Est. Monthly ${fmt(estMonthly)} / ${fmt(monthlyLimit)})`;
    }
  }
  </script>

  <!-- 5) TARIFF TABLE POPULATOR + BOOT -->
  <script>
  function populateTariffTable(tariffData, mode="normal") {
    if (!tariffData) return;
    const t = tariffData;
    const arr = (mode==="indirimli") ? t.indirimli : t.normal;
    const tbody = document.getElementById("tariffBody");
    tbody.innerHTML = "";
    for (let i=0;i<arr.length;i++){
      const row = document.createElement("tr");
      row.innerHTML = `<td>Kademe ${i+1}</td><td>${fmt(arr[i].su,2)}</td><td>${fmt(arr[i].atik,2)}</td>`;
      tbody.appendChild(row);
    }
    document.getElementById("tariff_ctv").textContent = fmt(t.ctv ?? t.CTV ?? 0,2);
    document.getElementById("tariff_kdv_su").textContent = fmt(t.kdv?.su ?? t.KDV?.su ?? 0,2);
    document.getElementById("tariff_kdv_atik").textContent = fmt(t.kdv?.atik ?? t.KDV?.atik ?? 0,2);
  }

  // bootstrap routine
  (async function boot() {
    // show/hide protected area based on session
    const protectedArea = document.getElementById("protectedArea");
    const accessScreen = document.getElementById("accessScreen");
    if (sessionStorage.getItem("energyAccess")==="granted") {
      accessScreen.style.display = "none";
      protectedArea.style.display = "block";
    } else {
      accessScreen.style.display = "flex";
      protectedArea.style.display = "none";
    }

    // wire access button
    document.getElementById("accessBtn").addEventListener("click", ()=>{
      const entered = document.getElementById("accessCode").value.trim();
      if (entered === ACCESS_CODE) {
        sessionStorage.setItem("energyAccess","granted");
        accessScreen.style.display = "none";
        protectedArea.style.display = "block";
        runAll();
      } else {
        const wp = document.getElementById("wrongPass");
        wp.style.display = "block";
        setTimeout(()=>wp.style.display="none",2000);
      }
    });

    // if already allowed, run
    if (sessionStorage.getItem("energyAccess")==="granted") runAll();
  })();

  async function runAll() {
    // update now text
    document.getElementById("nowText").textContent = new Date().toLocaleString();
    // read monthly analysis
    const monthlyData = readMonthlyAnalysis();
    // run gas & elec & water
    await updateConsumption(gasConfig, monthlyData);
    await updateConsumption(elecConfig, monthlyData);
    await updateConsumption(waterConfig, monthlyData);
  }

  // also expose runAll to console
  window.runAll = runAll;
  </script>

</body>
</html>
