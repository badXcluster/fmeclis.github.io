<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
<title>Energy Consumption</title>
  
<style>
  body { font-family: Arial, Helvetica, sans-serif; padding: 18px; background:#f7f7f7; color:#111; }
  h1 { margin:0 0 10px 0; font-size:20px; }
  .sheet { background: white; padding:14px; border-radius:6px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); max-width:1100px; }
  table { border-collapse: collapse; width:100%; margin-bottom:18px; }
  th, td { border:1px solid #cfcfcf; padding:8px 10px; font-size:14px; vertical-align:middle; }
  th { background:#e6f0ff; text-align:left; font-weight:700; }
  td.num { text-align:right; font-family: "Courier New", monospace; }
  .section-title { background:#d9eafc; font-weight:700; font-size:15px; padding:8px; margin-bottom:8px; border-radius:4px; }
  .muted { color:#666; font-size:13px; }
  .warning { background:#fff3f0; color:#8a1f00; padding:6px 8px; border-radius:4px; display:inline-block; font-weight:700; }
  .red { color:#b30000; font-weight:700; }
  .small { font-size:13px; color:#333; }
  .meta { display:flex; gap:12px; margin-bottom:10px; align-items:center; }
  .meta .pill { background:#eef3ff; padding:6px 8px; border-radius:6px; font-size:13px; }
  .footnote { font-size:12px; color:#555; margin-top:8px; }
  @media (max-width:700px){ table, th, td { font-size:13px; } }
</style>
</head>
<body>
<div class="sheet">
  <h1>HOME — Energy Consumption Dashboard</h1>
  <div class="meta">
    
  </div>

  <!-- BASKENTGAZ -->
  <div class="section-title">BAŞKENTGAZ<div class="pill">Auto-updates: <span id="nowText"></span></div></div>
  <table id="gasTable">
    <thead>
      <tr>
        <th>Label</th>
        <th>First Reading Date</th>
        <th>First Reading</th>
        <th>Last Reading Date</th>
        <th>Last Reading</th>
        <th>Days Passed</th>
        <th>Consumption (m³)</th>
        <th>Daily AVG (m³/d)</th>
        <th>Estimated Monthly Cons. (m³)</th>
        <th>Unit Price (m3/TL)</th>
        <th>Estimated Monthly Cost (TL)</th>
        <th>Actual Cost (TL)</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td class="small">Period</td>
        <td id="firstDateCell">--</td>
        <td id="firstReadingCell" class="num">--</td>
        <td id="nowDateCell">--</td>
        <td id="lastReadingCell" class="num">--</td>
        <td id="daysCell" class="num">--</td>
        <td id="consCell" class="num">--</td>
        <td id="dailyAvgCell" class="num">--</td>
        <td id="estMonthlyCell" class="num">--</td>
        <td id="unitPriceCell" class="num">--</td>
        <td id="estMonthlyCostCell" class="num">--</td>
        <td id="periodTotalCostCell" class="num">--</td>
      </tr>
      <tr>
        <td class="small">Note</td>
        <td colspan="11" id="limitNote" class="small">Limit check will appear here.</td>
      </tr>
    </tbody>
  </table>

  <!-- MONTHLY ANALYSIS -->
  <div class="section-title">MONTHLY GAS ANALYSIS for past 5 years - Daily average consumptions</div>
  <table id="monthlyAnalysis">

    <tbody>
      <!-- Embedded monthly averages from your HOME sheet -->
      <tr><th>Month of year</th><td>Ocak</td><td>Şubat</td><td>Mart</td><td>Nisan</td><td>Mayıs</td><td>Haziran</td><td>Temmuz</td>
        <td>Ağustos</td><td>Eylül</td><td>Ekim</td><td>Kasım</td><td>Aralık</td></tr>
      <tr><th>Daily AVG (m³/d)</th><td>3.23</td><td>3.91</td><td>2.97</td><td>1.92</td><td>0.89</td><td>0.77</td><td>0.66</td>
        <td>0.56</td><td>0.72</td><td>1.37</td><td>2.75</td><td>3.35</td></tr>
      <tr><th>Monthly AVG (m³/mo)</th><td>100.21</td><td>113.46</td><td>91.99</td><td>57.47</td><td>27.74</td><td>23.07</td><td>20.61</td>
        <td>17.50</td><td>21.52</td><td>42.61</td><td>82.62</td><td>103.78</td></tr>  
    </tbody>
  </table>

  <!-- ENERJISA (placeholder) -->
  <div class="section-title">ENERJISA (Electricity) — Placeholder</div>
  <table>
    <thead><tr><th>Label</th><th>Value</th></tr></thead>
    <tbody>
      <tr><td>Note</td><td class="small">Currently empty — formatted for future use.</td></tr>
    </tbody>
  </table>

  <!-- ASKI (Water) placeholder -->
  <div class="section-title">ASKI (Water) — Placeholder</div>
  <table>
    <thead><tr><th>Label</th><th>Value</th></tr></thead>
    <tbody>
      <tr><td>Note</td><td class="small">Currently empty — formatted for future use.</td></tr>
    </tbody>
  </table>

  <div class="footnote">
    <strong>How to publish updates:</strong> Edit the values in the script section of this file (see variables near top of the script) and commit/push to your GitHub Pages repo. The page will then recalculate for viewers using their current time (so derived daily averages and estimates change as time passes).
  </div>
</div>

<script>
/* ===== EDIT THESE VALUES BEFORE PUBLISHING =====
   - firstDateStr: the first reading timestamp (ISO format or YYYY-MM-DDTHH:mm:ss)
   - firstReading: numeric first reading
   - lastDateStr: the timestamp of the last reading (you can keep it fixed)
   - lastReading: numeric last reading
   - unitPrice: TL per m³ (set to 11.50 as requested)
*/
const firstDateStr = "2025-10-06T11:19:57";   // First reading datetime (edit if needed)
const firstReading = 6982;                    // First reading value
const lastDateStr = "2025-10-06T11:19:57";    // (Optional) The timestamp of the last recorded reading. Keep fixed or update when you update reading.
const lastReading = 7024.67;                  // Last meter reading (fixed until you update)
const unitPrice = 11.50;                      // TL per m³ (updated to 11.50)
/* ===== End editable block ===== */

/* Turkish month names map */
const monthNamesTr = ["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"];

function readMonthlyAnalysis() {
  const table = document.getElementById('monthlyAnalysis');
  const rows = table.querySelectorAll('tbody tr');
  const map = {};
  rows.forEach(r => {
    const cols = r.querySelectorAll('td');
    if(cols.length >= 3) {
      const month = cols[0].textContent.trim();
      const dailyAvg = parseFloat(cols[1].textContent) || 0;
      const monthlyAvg = parseFloat(cols[2].textContent) || 0;
      map[month] = { dailyAvg, monthlyAvg };
    }
  });
  return map;
}

function recalcAndRender() {
  const now = new Date();
  document.getElementById('nowText').textContent = now.toLocaleString();

  const firstDate = new Date(firstDateStr);
  // Use current "now" as the second timestamp for dynamic daily average.
  let daysPassed = (now - firstDate) / (1000*60*60*24); // fractional days
  if (daysPassed <= 0.00001) daysPassed = 0.00001; // avoid divide-by-zero

  const consumption = (lastReading - firstReading); // measured consumption since firstReading
  const dailyAvg = consumption / daysPassed;
  const estMonthly = dailyAvg * 30;

  // Correct cost calculations:
  const periodTotalCost = consumption * unitPrice;    // cost for the measured consumption (period)
  const estMonthlyCost = estMonthly * unitPrice;      // estimated monthly cost (based on estMonthly)

  // Monthly limit lookup (based on current month)
  const monthName = monthNamesTr[now.getMonth()];
  const monthlyMap = readMonthlyAnalysis();
  const monthlyAvgInfo = monthlyMap[monthName] || {monthlyAvg: 0, dailyAvg:0};
  const monthlyAvg = monthlyAvgInfo.monthlyAvg || 0;
  const limit = monthlyAvg * 1.25;
  const overLimit = estMonthly > limit;
  const extraVolume = overLimit ? (estMonthly - limit) : 0;
  const extraPayment = extraVolume * unitPrice;

  const fmt = (v, dp=2) => {
    if (v === null || typeof v === 'undefined' || isNaN(v)) return "--";
    return Number(v).toLocaleString(undefined, {minimumFractionDigits: dp, maximumFractionDigits: dp});
  };

  // Write values to UI
  document.getElementById('firstDateCell').textContent = new Date(firstDateStr).toLocaleString();
  document.getElementById('nowDateCell').textContent = now.toLocaleString();
  document.getElementById('firstReadingCell').textContent = fmt(firstReading, 2);
  document.getElementById('lastReadingCell').textContent = fmt(lastReading, 2);
  document.getElementById('daysCell').textContent = fmt(daysPassed, 4);
  document.getElementById('consCell').textContent = fmt(consumption, 3);
  document.getElementById('dailyAvgCell').textContent = fmt(dailyAvg, 4);
  document.getElementById('estMonthlyCell').textContent = fmt(estMonthly, 3);
  document.getElementById('unitPriceCell').textContent = fmt(unitPrice, 2);
  document.getElementById('estMonthlyCostCell').textContent = fmt(estMonthlyCost, 2);
  document.getElementById('periodTotalCostCell').textContent = fmt(periodTotalCost, 2);

  // Limit note
  const noteEl = document.getElementById('limitNote');
  if (monthlyAvg <= 0) {
    noteEl.innerHTML = `Monthly average for <strong>${monthName}</strong> not found (or zero) in analysis table. Limit check unavailable.`;
  } else {
    let note = `Current month: <strong>${monthName}</strong>. Monthly AVG = ${fmt(monthlyAvg,3)} m³. Limit (AVG +25%) = ${fmt(limit,3)} m³. `;
    if (overLimit) {
      note += `<span class="warning">⚠️ Estimated monthly (${fmt(estMonthly,3)} m³) exceeds limit. Extra volume: ${fmt(extraVolume,3)} m³ → Extra payment estimate: <span class="red">${fmt(extraPayment,2)} TL</span></span>`;
    } else {
      note += `Estimated monthly (${fmt(estMonthly,3)} m³) is within the limit.`;
    }
    noteEl.innerHTML = note;
  }
}

// initial render + periodic updates (every 30s)
recalcAndRender();
setInterval(recalcAndRender, 30*1000);
</script>
</body>
</html>
